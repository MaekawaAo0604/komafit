# Requirements Document

## Introduction

入塾割当アシスタントは、塾の入塾・時間割調整時における担当講師アサインを自動化し、条件漏れなく高速化するシステムです。Excel/スプレッドシート運用で発生する手作業ミス、属人化、監査不可といった課題を解決し、「なぜこの講師にしたか」を説明可能な透明性のある割当プロセスを提供します。

本システムは3つのロール（管理者、講師、閲覧）を持ち、コマ（0,1,A,B,C）とslot_id（DAY-KOMA形式）を使用した週次繰り返しの授業枠管理を行います。割当ボードで先生欄をクリックすると、ハード制約を満たす候補講師をソフト条件でソートして提示し、全ての割当変更を監査ログに記録します。

### ビジネス価値
- 講師アサインの所要時間を大幅削減（Excel運用と比較して）
- 条件漏れによる不適切な割当を防止
- 変更履歴の完全な追跡可能性による監査対応
- Undo機能による誤操作からの即座の復旧

---

## Requirements

### Requirement 1: ロール・権限管理
**User Story:** システム管理者として、各ユーザーに適切なロールを割り当てることで、データの整合性とセキュリティを保ちたい

#### Acceptance Criteria

1. WHEN ユーザーがシステムにログインする THEN システムはそのユーザーのロール（管理者/講師/閲覧）を識別し適切な権限を付与しなければならない

2. IF ユーザーのロールが講師である THEN システムは自分の空き枠データ以外の編集権限を与えてはならない

3. IF ユーザーのロールが管理者である THEN システムは生徒登録、授業枠入力、講師登録、割当の確定・変更、設定変更、CSV入出力の全機能へのアクセスを許可しなければならない

4. IF ユーザーのロールが閲覧である THEN システムはデータの参照のみを許可し、いかなる編集操作も拒否しなければならない

5. IF ユーザーのロールが講師である AND 生徒の個人情報にアクセスしようとする THEN システムは自分が担当する生徒の情報のみを表示しなければならない

6. WHEN ロール権限外の操作が試みられる THEN システムは操作を拒否し、権限不足のエラーメッセージを表示しなければならない

---

### Requirement 2: コマ・スロット定義マスタ
**User Story:** システム管理者として、授業コマとスロットの定義を正確に管理し、表示順序を保証したい

#### Acceptance Criteria

1. システムは固定5種類のコマ（0, 1, A, B, C）をサポートしなければならない

2. WHEN コマが画面に表示される THEN システムは常に「0 → 1 → A → B → C」の順序で表示しなければならない

3. システムはコママスタで順序情報を保持し、文字列ソートに依存してはならない

4. システムはslot_idを「DAY-KOMA」形式（例：MON-A、TUE-0）で管理しなければならない

5. IF 校舎が複数存在する THEN システムはslot_idを「CAMPUS-DAY-KOMA」形式に拡張しなければならない

6. WHEN 管理者がコママスタを編集する THEN システムは変更内容を保存し、既存のスロット定義に影響を与えてはならない

---

### Requirement 3: 講師マスタ管理
**User Story:** 管理者として、各講師の対応教科、学年、指導可能人数などの情報を正確に管理したい

#### Acceptance Criteria

1. WHEN 管理者が新規講師を登録する THEN システムは講師ID、氏名、有効/無効ステータスを必須項目として保存しなければならない

2. システムは各講師について対応可能な教科のリストを保持しなければならない

3. システムは各講師について対応可能な学年の範囲（最小学年〜最大学年）を保持しなければならない

4. システムは各講師について1:2指導の可否フラグを保持しなければならない

5. システムは各講師について週あたりの上限コマ数を保持しなければならない

6. システムは各講師について同時担当可能な生徒数の上限を保持しなければならない

7. WHEN 管理者が講師情報を編集する THEN システムは変更内容をAuditLogに記録しなければならない

8. IF 講師が無効化される THEN システムは今後の割当候補から除外しなければならない AND 既存の割当には影響を与えてはならない

---

### Requirement 4: 生徒マスタ管理
**User Story:** 管理者として、生徒の学年、受講教科、NG講師などの情報を管理したい

#### Acceptance Criteria

1. WHEN 管理者が新規生徒を登録する THEN システムは生徒ID、氏名、学年、有効/無効ステータスを必須項目として保存しなければならない

2. システムは各生徒について受講教科のリストを保持しなければならない

3. システムは各生徒について指定されたNG講師のリストを保持しなければならない

4. WHEN 管理者が生徒のNG講師を設定する THEN システムはその講師を当該生徒の割当候補から除外しなければならない

5. WHEN 管理者が生徒情報を編集する THEN システムは変更内容をAuditLogに記録しなければならない

6. IF 生徒が無効化される THEN システムは授業枠から削除されていない場合は警告を表示しなければならない

---

### Requirement 5: 授業枠（スロット）管理
**User Story:** 管理者として、週次スケジュールの各スロットに生徒を配置し、授業枠を構成したい

#### Acceptance Criteria

1. WHEN 管理者が授業枠を作成する THEN システムはslot_id（DAY-KOMA形式）を識別子として使用しなければならない

2. 各授業枠は最大2人の生徒（座席1、座席2）を配置可能でなければならない

3. WHEN 管理者が授業枠に生徒を配置する THEN システムは配置時点でその枠の教科を確定させなければならない

4. IF 生徒が複数教科を受講する場合 THEN システムは授業枠ごとに教科を個別に指定させなければならない

5. WHEN 管理者が座席1に生徒を配置する THEN システムは講師が未割当でも許可しなければならない

6. WHEN 管理者が座席2に生徒を追加する THEN システムは既に座席1に生徒が配置されていることを確認しなければならない

7. WHEN 管理者が授業枠から生徒を削除する THEN システムは確認ダイアログを表示し、削除操作をAuditLogに記録しなければならない

8. IF 授業枠に担当講師が割り当てられている AND 生徒が削除される THEN システムは割当が無効になる可能性を警告しなければならない

---

### Requirement 6: 講師空き枠管理
**User Story:** 講師として、自分の週次スケジュールで空いているコマを入力・更新したい

#### Acceptance Criteria

1. WHEN 講師が講師ページにアクセスする THEN システムは週次カレンダー（MON-0〜SUN-C）を表示しなければならない

2. WHEN 講師が特定のスロットをクリックする THEN システムは空き状態（ON/OFF）をトグルしなければならない

3. WHEN 講師が空き枠を変更する THEN システムは変更内容（誰が、いつ、どのスロット）をAuditLogに記録しなければならない

4. システムは各講師の空き枠情報をTeacherAvailabilityテーブルに保存しなければならない

5. WHEN 講師が既に割当済みのスロットの空き枠を削除しようとする THEN システムは警告を表示し、割当への影響を通知しなければならない

6. WHEN 講師ページが表示される THEN システムは自分の現在の担当一覧（いつ・誰・教科）を表示しなければならない

---

### Requirement 7: 講師推薦エンジン（ハード制約）
**User Story:** 管理者として、授業枠に対してハード制約を満たす講師のみを候補として表示させたい

#### Acceptance Criteria

1. WHEN 管理者が割当ボードの先生欄をクリックする THEN システムはそのスロットの候補講師リストを表示しなければならない

2. IF 講師が対象スロットで空き枠を登録していない THEN システムはその講師を候補から除外しなければならない

3. IF 授業枠内の全ての生徒について、講師の対応教科リストに該当教科が含まれていない THEN システムはその講師を候補から除外しなければならない

4. IF 授業枠内のいずれかの生徒について、講師の対応学年範囲に該当学年が含まれていない THEN システムはその講師を候補から除外しなければならない

5. IF 授業枠内のいずれかの生徒のNG講師リストに該当講師が含まれる THEN システムはその講師を候補から除外しなければならない

6. IF 講師の週あたりの上限コマ数が既に達している THEN システムはその講師を候補から除外しなければならない

7. IF 講師の同時担当可能な生徒数の上限が既に達している THEN システムはその講師を候補から除外しなければならない

8. IF 授業枠に2人の生徒が配置されている AND 講師の1:2指導可否フラグがfalseである THEN システムはその講師を候補から除外しなければならない

9. IF 授業枠に2人の生徒が配置されている AND システム設定で同一教科必須が有効 AND 2人の教科が異なる THEN システムはその講師を候補から除外しなければならない

10. IF 授業枠に2人の生徒が配置されている AND システム設定で学年差上限が設定されている AND 2人の学年差が上限を超える THEN システムはその講師を候補から除外しなければならない

---

### Requirement 8: 講師推薦エンジン（ソフト条件・優先順位）
**User Story:** 管理者として、ハード制約を満たす候補講師をソフト条件で最適な順序にソートして表示させたい

#### Acceptance Criteria

1. WHEN 候補講師リストが表示される THEN システムはソフト条件に基づいてスコアリングし、推奨順にソートしなければならない

2. システムは講師の現在の負荷（当日/週の担当数またはコマ数）を計算し、負荷が低い講師を優先しなければならない

3. IF 講師の希望条件（校舎、経験など）が設定されている THEN システムは希望条件に一致する講師のスコアを加算しなければならない

4. IF 授業枠に2人の生徒が配置されている THEN システムは学年差が小さい、または同一教科である場合にスコアを加算しなければならない

5. IF 授業枠が既存の割当の変更である THEN システムは現在の担当講師（継続性）のスコアを加算しなければならない

6. システムはソフト条件の重みをSettingsファイルから読み込み、動的に調整可能でなければならない

7. システムはソフト条件の重みをコードに埋め込んではならない

---

### Requirement 9: 候補講師リスト表示
**User Story:** 管理者として、候補講師の情報と推薦理由を明確に理解して選択したい

#### Acceptance Criteria

1. WHEN 候補講師リストが表示される THEN システムは各講師について以下の情報を表示しなければならない：講師名、条件一致の根拠、負荷（当日/週の担当数またはコマ数）

2. システムは各候補講師について条件一致の根拠を短く簡潔に表示しなければならない

3. システムは任意で各講師の他コマの空き状況を表示してもよい

4. IF 候補講師が0人である THEN システムは「候補が見つかりません」メッセージと共に、条件を満たさなかった理由の集計を表示しなければならない

5. WHEN 候補が0人の理由が表示される THEN システムは以下の理由を集計して表示しなければならない：空き枠なし、教科NG、学年NG、NG講師、上限超過

6. WHEN 管理者が候補講師リストから講師を選択する THEN システムは選択した講師を確定前にハイライト表示しなければならない

---

### Requirement 10: 講師割当の確定
**User Story:** 管理者として、候補講師から選択した講師を授業枠に確定し、変更履歴を記録したい

#### Acceptance Criteria

1. WHEN 管理者が候補講師リストから講師を選択し確定ボタンをクリックする THEN システムは選択した講師を授業枠に割り当てなければならない

2. WHEN 講師割当が確定される THEN システムはSlotTeacherテーブルに講師ID、割当者ID、割当日時を保存しなければならない

3. WHEN 講師割当が確定される THEN システムはその講師の空き枠を消化済みとしてマークしなければならない

4. WHEN 講師割当が確定される THEN システムは割当操作をAuditLogに記録しなければならない（誰が、いつ、どの講師を、どのスロットに）

5. WHEN 講師割当が確定される THEN システムは割当ボードの該当セルに講師名を表示しなければならない

6. WHEN 講師割当が確定される THEN システムは確定操作を直近の操作履歴に追加し、Undo可能な状態にしなければならない

---

### Requirement 11: 講師割当の変更・解除
**User Story:** 管理者として、既に割り当てた講師を変更または解除し、変更理由を記録したい

#### Acceptance Criteria

1. WHEN 管理者が割当済みの先生欄をクリックする THEN システムは「変更」と「解除」の選択肢を含むメニューを表示しなければならない

2. WHEN 管理者が「変更」を選択する THEN システムは候補講師リストを再表示しなければならない

3. WHEN 管理者が「解除」を選択する THEN システムは確認ダイアログを表示しなければならない

4. WHEN 解除が確定される THEN システムはSlotTeacherテーブルの講師IDをNULLに更新しなければならない

5. WHEN 解除が確定される THEN システムは解除された講師の空き枠を利用可能な状態に戻さなければならない

6. WHEN 講師割当が変更される THEN システムは変更操作（変更前講師、変更後講師、変更者、変更日時）をAuditLogに記録しなければならない

7. WHEN 講師割当が解除される THEN システムは解除操作（解除された講師、解除者、解除日時）をAuditLogに記録しなければならない

8. WHEN 講師割当が変更または解除される THEN システムは操作を直近の操作履歴に追加し、Undo可能な状態にしなければならない

---

### Requirement 12: Undo機能
**User Story:** 管理者として、誤って実行した割当操作を即座に取り消したい

#### Acceptance Criteria

1. システムは直近の割当操作（確定、変更、解除）を保持しなければならない

2. WHEN 管理者がUndo操作を実行する THEN システムは直近の操作を取り消し、操作前の状態に戻さなければならない

3. WHEN Undo操作が実行される THEN システムは講師の空き枠状態を元に戻さなければならない

4. WHEN Undo操作が実行される THEN システムはSlotTeacherテーブルを元の状態に戻さなければならない

5. WHEN Undo操作が実行される THEN システムはUndo操作自体もAuditLogに記録しなければならない（どの操作を取り消したか）

6. IF Undo可能な操作が存在しない THEN システムはUndoボタンを無効化しなければならない

7. システムはUndo可能な操作を1件のみ保持すればよい（連続Undoは不要）

---

### Requirement 13: 割当ボード表示
**User Story:** 管理者として、週次スケジュール全体を一覧し、各スロットの割当状況を把握したい

#### Acceptance Criteria

1. WHEN 管理者が割当ボードにアクセスする THEN システムは週次スケジュール（曜日×コマ）のグリッド形式で表示しなければならない

2. 各セルは先生欄（上部）と生徒枠（最大2段、下部）を含まなければならない

3. WHEN スロットに講師が割当済みである THEN システムは先生欄に講師名を表示しなければならない

4. WHEN スロットに講師が未割当である THEN システムは先生欄を空白で表示しなければならない

5. 各生徒枠は左側に「学年・教科」、右側に「生徒名」を表示しなければならない

6. IF スロットに1人の生徒のみ配置されている THEN システムは座席2を空白で表示しなければならない

7. WHEN 管理者が生徒枠をクリックする THEN システムは生徒の差し替え/削除メニューを表示しなければならない（管理者のみ）

8. IF ユーザーのロールが講師または閲覧である THEN システムは生徒枠のクリック操作を無効にしなければならない

---

### Requirement 14: 監査ログ
**User Story:** システム管理者として、全ての割当操作の履歴を追跡し、監査に対応したい

#### Acceptance Criteria

1. システムは全ての割当操作（確定、変更、解除、Undo）をAuditLogsテーブルに記録しなければならない

2. 各AuditLogレコードは以下の情報を含まなければならない：操作者ID、操作種別、操作対象（ペイロード）、作成日時

3. WHEN 講師が空き枠を変更する THEN システムは変更内容（講師ID、スロットID、変更前状態、変更後状態）をAuditLogに記録しなければならない

4. WHEN 管理者がマスタデータを編集する THEN システムは変更内容（テーブル名、レコードID、変更前値、変更後値）をAuditLogに記録しなければならない

5. システムは監査ログを削除してはならない（論理削除または永続保存）

6. WHEN 管理者が監査ログを閲覧する THEN システムは操作者、操作日時、操作種別、操作内容でフィルタリング可能でなければならない

7. システムは監査ログの閲覧権限を管理者ロールに限定しなければならない

---

### Requirement 15: CSV入出力（インポート）
**User Story:** 管理者として、既存のExcelデータをCSV形式でインポートし、移行を効率化したい

#### Acceptance Criteria

1. システムは以下のデータ種別のCSVインポートをサポートしなければならない：講師マスタ、講師空き枠、生徒マスタ、授業枠、NG講師

2. WHEN 管理者がCSVファイルをアップロードする THEN システムはファイル形式（列名、データ型）の妥当性を検証しなければならない

3. WHEN CSVデータに欠損または矛盾が検出される THEN システムはインポートを中断し、エラー一覧（行番号＋理由）を表示しなければならない

4. システムは以下の欠損・矛盾をチェックしなければならない：必須項目の欠損、外部キー整合性（存在しないID参照）、データ型不一致、重複キー

5. WHEN CSVインポートが成功する THEN システムはインポート件数（新規作成/更新）を表示しなければならない

6. WHEN CSVインポートが実行される THEN システムはインポート操作をAuditLogに記録しなければならない（誰が、いつ、何件）

7. システムはインポート時に既存データとの重複を検出し、更新または新規作成のオプションを提供しなければならない

---

### Requirement 16: CSV入出力（エクスポート）
**User Story:** 管理者として、現在のデータをCSV形式でエクスポートし、バックアップや外部分析に利用したい

#### Acceptance Criteria

1. システムは以下のデータ種別のCSVエクスポートをサポートしなければならない：講師マスタ、講師空き枠、生徒マスタ、授業枠、割当状況、NG講師

2. WHEN 管理者がエクスポート機能を実行する THEN システムは選択したデータ種別の全レコードをCSV形式でダウンロードしなければならない

3. システムはエクスポートファイル名に日時を含めなければならない（例：teachers_20260210_153000.csv）

4. WHEN CSVエクスポートが実行される THEN システムはエクスポート操作をAuditLogに記録しなければならない（誰が、いつ、何を）

5. システムはエクスポートデータに個人情報が含まれる場合、ダウンロード前に確認ダイアログを表示しなければならない

---

### Requirement 17: システム設定管理
**User Story:** 管理者として、ソフト条件の重みや1:2ルールなどをGUIで設定・調整したい

#### Acceptance Criteria

1. システムは以下の設定項目をGUIで管理可能でなければならない：ソフト条件の重み（負荷優先度、継続性優先度など）、1:2ルール（同一教科必須、学年差上限）

2. WHEN 管理者が設定を変更する THEN システムは変更内容を設定ファイル（コードではなく外部設定）に保存しなければならない

3. WHEN 管理者が設定を変更する THEN システムは変更内容をAuditLogに記録しなければならない

4. WHEN 推薦エンジンが実行される THEN システムは最新の設定値を読み込んでスコアリングしなければならない

5. システムは設定値のバリデーションを行い、不正な値（負の重み、範囲外の値など）を拒否しなければならない

---

### Requirement 18: エラー処理とユーザー通知
**User Story:** システムユーザーとして、エラーが発生した際に原因を理解し、適切に対処したい

#### Acceptance Criteria

1. WHEN システムエラーが発生する THEN システムはユーザーに分かりやすいエラーメッセージを表示しなければならない

2. WHEN 操作が権限不足で拒否される THEN システムは「権限がありません」と表示し、必要なロールを示さなければならない

3. WHEN データ検証エラーが発生する THEN システムはエラー箇所（フィールド名）と理由を明示しなければならない

4. WHEN ネットワークエラーが発生する THEN システムは再試行を促すメッセージを表示しなければならない

5. システムは予期しないエラーをログに記録し、ユーザーには「エラーが発生しました。管理者に連絡してください」と表示しなければならない

---

## Non-Functional Requirements

### パフォーマンス
1. WHEN 割当ボードが表示される THEN システムは3秒以内にページを描画しなければならない
2. WHEN 候補講師リストが生成される THEN システムは2秒以内に結果を返さなければならない
3. システムは同時に10人の管理者の操作を遅延なく処理できなければならない

### セキュリティ
1. システムは全ての通信をHTTPSで暗号化しなければならない
2. システムはパスワードをハッシュ化して保存しなければならない
3. システムはセッションタイムアウトを30分に設定しなければならない

### 可用性
1. システムは平日9:00-22:00の間、99%以上の稼働率を維持しなければならない
2. システムは定期バックアップを毎日実行しなければならない

### ユーザビリティ
1. システムはスマートフォン、タブレット、PCの各デバイスで利用可能でなければならない
2. システムは主要な操作をキーボードショートカットでも実行可能でなければならない

---

**STATUS**: 要件生成完了
**NEXT STEP**: 要件をレビューし、承認後に `/kiro:spec-design teacher-assignment-system` で設計フェーズに進む
