# 要件定義書

## イントロダクション

### 機能概要
定期授業パターンシステムは、講師が曜日ベースで繰り返される授業パターンを登録し、月次カレンダーに自動的に展開する機能です。これにより、毎週同じ時間に同じ生徒を教える場合の入力作業を大幅に削減し、定期授業の管理を効率化します。

### ビジネス価値
- **入力作業の大幅削減**: 1回の登録で1ヶ月分以上の授業予定を自動生成
- **定期授業の一括管理**: パターン単位での編集・削除により、複数日程の一括変更が可能
- **柔軟な例外処理**: 個別の日付で休み、振替、講師変更などの例外対応が可能
- **視認性の向上**: 定期パターンと個別アサインを色分け表示し、スケジュールの把握が容易

### システム統合
本機能はV2システム（日付ベースのスケジューリング）に統合され、既存の`assignments`テーブルおよび`teacher_availability_v2`テーブルと連携します。

---

## 要件

### 要件1: 定期授業パターンの登録

**ユーザーストーリー**:
講師または管理者として、曜日ベースの定期授業パターン（曜日、コマ、生徒、科目）を登録したい。これにより、毎週繰り返される授業の入力作業を削減できる。

#### 受入基準

1. **WHEN** 講師または管理者が定期授業パターン登録フォームを開く **THEN** システムは以下の入力フィールドを表示する **SHALL**
   - 曜日選択（日曜日〜土曜日）
   - コマ選択（1, A, B, C）
   - 講師選択（管理者の場合は全講師、講師の場合は自分のみ）
   - 生徒選択（アクティブな生徒のリスト）
   - 科目入力（生徒の受講科目から選択）
   - 開始日（必須）
   - 終了日（任意、未指定の場合は無期限）

2. **WHEN** 全ての必須フィールドが入力され、登録ボタンがクリックされる **THEN** システムは入力内容を検証し、検証が成功した場合はパターンを保存する **SHALL**

3. **IF** 同じ曜日、コマ、講師、生徒の組み合わせで既に有効なパターンが存在する **THEN** システムはエラーメッセージ「この組み合わせは既に登録されています」を表示し、登録を拒否する **SHALL**

4. **WHEN** パターン登録が成功する **THEN** システムは以下の処理を実行する **SHALL**
   - `recurring_assignments`テーブルにレコードを作成
   - 成功メッセージを表示
   - パターン一覧画面にリダイレクト
   - 監査ログに登録操作を記録

5. **IF** 講師ロールのユーザーがパターンを登録する **THEN** システムは講師フィールドに自動的に自分のIDを設定し、変更不可とする **SHALL**

6. **IF** 終了日が開始日より前の日付である **THEN** システムはエラーメッセージ「終了日は開始日以降の日付を指定してください」を表示する **SHALL**

---

### 要件2: 定期授業パターンの管理

**ユーザーストーリー**:
講師または管理者として、登録済みの定期授業パターンを閲覧、編集、削除したい。これにより、スケジュール変更に柔軟に対応できる。

#### 受入基準

1. **WHEN** 講師または管理者がパターン一覧画面を開く **THEN** システムは以下の情報を含むパターンリストを表示する **SHALL**
   - 曜日
   - コマ（時間帯）
   - 講師名
   - 生徒名
   - 科目
   - 有効期間（開始日〜終了日）
   - 状態（有効/無効）

2. **IF** 講師ロールのユーザーがパターン一覧を開く **THEN** システムは自分が担当する講師のパターンのみを表示する **SHALL**

3. **IF** 管理者がパターン一覧を開く **THEN** システムは全講師のパターンを表示し、講師名でフィルタリング可能とする **SHALL**

4. **WHEN** パターン編集ボタンがクリックされる **THEN** システムは編集フォームを表示し、以下のフィールドを編集可能とする **SHALL**
   - 生徒（変更可能）
   - 科目（変更可能）
   - 終了日（変更可能、削除も可能）
   - 状態（有効/無効の切り替え）

   **注**: 曜日、コマ、講師は変更不可（変更する場合は削除して再登録）

5. **WHEN** パターン編集が保存される **THEN** システムは以下の処理を実行する **SHALL**
   - `recurring_assignments`テーブルを更新
   - 更新日時を記録
   - 成功メッセージを表示
   - 監査ログに編集操作を記録

6. **WHEN** パターン削除ボタンがクリックされる **THEN** システムは確認ダイアログ「このパターンを削除しますか？個別の例外処理は保持されます。」を表示する **SHALL**

7. **WHEN** 削除が確認される **THEN** システムは以下の処理を実行する **SHALL**
   - `recurring_assignments`テーブルから該当レコードを削除
   - 個別の例外処理（`assignments`テーブルの個別アサイン）は保持
   - 成功メッセージを表示
   - 監査ログに削除操作を記録

8. **IF** パターンの状態が「無効」に設定される **THEN** システムは月次カレンダーへの自動展開を停止し、既存の個別アサインは保持する **SHALL**

---

### 要件3: パターンの月次カレンダーへの自動展開

**ユーザーストーリー**:
講師または管理者として、登録した定期授業パターンが月次カレンダーに自動的に表示されることを期待する。これにより、毎月の授業予定を手動で入力する必要がなくなる。

#### 受入基準

1. **WHEN** 月次カレンダーがロードされる **THEN** システムは以下の処理を実行する **SHALL**
   - 表示月の日付範囲を計算
   - 該当する定期授業パターンを`recurring_assignments`テーブルから取得
   - 各パターンについて、該当する曜日の日付にマッピング
   - パターンから生成された授業を月次カレンダーに表示

2. **IF** 定期授業パターンの開始日が表示月内にある **THEN** システムは開始日以降の該当曜日にのみパターンを展開する **SHALL**

3. **IF** 定期授業パターンの終了日が表示月内にある **THEN** システムは終了日以前の該当曜日にのみパターンを展開する **SHALL**

4. **IF** 定期授業パターンの終了日が未設定（無期限）である **THEN** システムは開始日以降の全ての該当曜日にパターンを展開する **SHALL**

5. **WHEN** 定期授業パターンから展開された授業がカレンダーに表示される **THEN** システムは以下の視覚的区別を提供する **SHALL**
   - 背景色: 青系（例: #E3F2FD）でパターン由来であることを示す
   - ラベル: 「定期」または「パターン」のバッジを表示
   - ツールチップ: パターンIDまたはパターン情報を表示

6. **IF** 同じ日付・コマ・講師に定期パターンと個別アサインの両方が存在する **THEN** システムは個別アサインを優先して表示し、パターンを上書きする **SHALL**

7. **WHEN** パターンから展開された授業がカレンダーに表示される **THEN** システムはクリック可能とし、以下の操作を提供する **SHALL**
   - 「この日だけ休み」: 個別の例外処理を作成
   - 「パターンを編集」: パターン編集画面へ遷移
   - 「詳細を表示」: パターン情報をモーダル表示

---

### 要件4: 個別日付での例外処理

**ユーザーストーリー**:
講師または管理者として、定期授業パターンの特定の日付だけを休みにしたり、別の生徒に変更したりしたい。これにより、祝日、講師の都合、生徒の振替などに柔軟に対応できる。

#### 受入基準

1. **WHEN** カレンダー上のパターン由来の授業セルで「この日だけ休み」がクリックされる **THEN** システムは以下の処理を実行する **SHALL**
   - 確認ダイアログ「この日のパターン授業を休みにしますか？」を表示
   - 確認後、`assignment_exceptions`テーブルに例外レコードを作成（タイプ: 'cancelled'）
   - カレンダー表示を更新し、該当セルをグレーアウト表示
   - 「休み」ラベルを表示

2. **WHEN** カレンダー上のパターン由来の授業セルで「生徒を変更」がクリックされる **THEN** システムは以下の処理を実行する **SHALL**
   - 生徒選択モーダルを表示
   - 選択後、`assignments`テーブルに個別アサインを作成（パターンIDを参照として保持）
   - カレンダー表示を更新し、変更後の生徒情報を緑系背景で表示
   - 「振替」または「個別」のバッジを表示

3. **WHEN** 個別アサインが作成される **AND** 同じ日付・コマ・講師にパターンが存在する **THEN** システムは個別アサインを優先して表示し、パターンを隠す **SHALL**

4. **WHEN** 例外処理（休みまたは個別アサイン）が削除される **THEN** システムはパターンからの自動展開を再度有効化し、パターン由来の授業を表示する **SHALL**

5. **IF** パターンが削除される **THEN** システムは関連する個別アサインを保持し、例外レコード（`assignment_exceptions`）のみを削除する **SHALL**

6. **WHEN** カレンダー上の例外処理済みセルがクリックされる **THEN** システムは以下の情報を含むモーダルを表示する **SHALL**
   - 元のパターン情報
   - 現在の状態（休み、または変更後の生徒）
   - 「元に戻す」ボタン

---

### 要件5: パターンと実際のアサインの統合表示

**ユーザーストーリー**:
講師または管理者として、月次カレンダーでパターン由来の授業と個別にアサインされた授業を区別して閲覧したい。これにより、スケジュール全体を正確に把握できる。

#### 受入基準

1. **WHEN** 月次カレンダーがロードされる **THEN** システムは以下の3種類の授業を統合して表示する **SHALL**
   - 定期パターン由来の授業（青系背景）
   - 個別アサイン（緑系背景）
   - 例外処理済み（グレー系背景または異なる背景色）

2. **WHEN** 同じ日付・コマ・講師に複数の授業タイプが存在する **THEN** システムは以下の優先順位で表示する **SHALL**
   1. 例外処理（休み） → グレーアウト表示
   2. 個別アサイン → 緑系背景で表示
   3. 定期パターン → 青系背景で表示

3. **WHEN** カレンダーセルにマウスホバーする **THEN** システムはツールチップで以下の情報を表示する **SHALL**
   - 授業タイプ（定期パターン / 個別アサイン / 例外処理）
   - パターンIDまたはアサインID
   - 登録日時
   - 登録者

4. **IF** 定期パターンから展開された授業である **THEN** システムはセル右上に「P」（Pattern）アイコンを表示する **SHALL**

5. **IF** 個別アサインである **THEN** システムはセル右上に「I」（Individual）アイコンを表示する **SHALL**

6. **WHEN** フィルタ機能が使用される **THEN** システムは以下のフィルタリングオプションを提供する **SHALL**
   - 全て表示（デフォルト）
   - 定期パターンのみ表示
   - 個別アサインのみ表示
   - 例外処理のみ表示

---

### 要件6: 権限管理とセキュリティ

**ユーザーストーリー**:
システム管理者として、講師が自分のパターンのみを管理でき、他の講師のパターンを変更できないようにしたい。これにより、データの整合性とセキュリティを保つ。

#### 受入基準

1. **IF** 講師ロールのユーザーがパターンを登録する **THEN** システムは講師フィールドに自動的に自分のIDを設定し、他の講師を選択できないようにする **SHALL**

2. **IF** 講師ロールのユーザーがパターン一覧を閲覧する **THEN** システムは自分が講師として登録されているパターンのみを表示する **SHALL**

3. **IF** 講師ロールのユーザーが他の講師のパターンを編集しようとする **THEN** システムは「権限がありません」エラーを表示し、編集を拒否する **SHALL**

4. **IF** 管理者ロールのユーザーである **THEN** システムは全講師のパターンの閲覧、登録、編集、削除を許可する **SHALL**

5. **WHEN** パターンの作成、編集、削除が実行される **THEN** システムは監査ログに以下の情報を記録する **SHALL**
   - 操作実行者のユーザーID
   - 操作タイプ（RECURRING_PATTERN_CREATE / UPDATE / DELETE）
   - 対象パターンID
   - 変更内容（JSON形式）
   - タイムスタンプ

6. **IF** viewerロールのユーザーである **THEN** システムはパターンの閲覧のみを許可し、登録、編集、削除を拒否する **SHALL**

---

### 要件7: データ整合性と制約

**ユーザーストーリー**:
システム管理者として、定期パターンと既存のV2システム（assignments, teacher_availability_v2）との整合性を保ちたい。これにより、データの矛盾を防ぎ、正確なスケジュール管理を実現する。

#### 受入基準

1. **WHEN** 定期パターンが登録される **THEN** システムは以下の制約をチェックする **SHALL**
   - 講師が存在すること
   - 生徒が存在すること
   - 時間帯（コマ）が有効であること
   - 講師が該当教科・学年を教えられること（teacher_skillsテーブル参照）
   - 生徒が該当教科を受講していること（student_subjectsテーブル参照）

2. **IF** 生徒が1対1必須（requires_one_on_one = TRUE）である **THEN** システムはパターン登録を許可し、カレンダー展開時に同じコマに他の生徒が追加されないよう警告を表示する **SHALL**

3. **IF** 講師が1対2指導不可（allow_pair = FALSE）である **THEN** システムはパターン登録を許可し、カレンダー展開時に同じコマに他の生徒が追加されないよう警告を表示する **SHALL**

4. **WHEN** パターンから展開された授業が月次カレンダーに表示される **THEN** システムは講師の空き枠（teacher_availability_v2）とは独立して表示し、空き枠の状態に影響を与えない **SHALL**

   **注**: 定期パターンは「予定」であり、講師の「来れる/来れない」の空き枠設定とは別の概念として扱う

5. **IF** パターンから展開された授業を実際のアサインに確定する場合 **THEN** システムはユーザーの明示的な操作（「確定」ボタンのクリック）を必要とし、以下の処理を実行する **SHALL**
   - `assignments`テーブルにレコードを作成
   - `teacher_availability_v2`のis_availableをFALSEに更新
   - 該当日付のカレンダー表示を「確定済み」に変更

6. **WHEN** 生徒または講師が無効化（active = FALSE）される **THEN** システムは関連する定期パターンの状態を自動的に「無効」に変更する **SHALL**

7. **WHEN** 定期パターンが削除される **THEN** システムは以下の処理を実行する **SHALL**
   - `recurring_assignments`テーブルから該当レコードを削除
   - 例外レコード（`assignment_exceptions`）を削除
   - 個別アサイン（`assignments`テーブル）は保持（削除しない）

---

### 要件8: ユーザビリティとUI/UX

**ユーザーストーリー**:
講師として、定期パターンの登録と管理を直感的かつ効率的に行いたい。これにより、システムの学習コストを削減し、日常的な利用を促進する。

#### 受入基準

1. **WHEN** 月次カレンダーが表示される **THEN** システムは以下のUI要素を提供する **SHALL**
   - 「パターン管理」ボタン: パターン一覧画面へ遷移
   - 「新規パターン」ボタン: パターン登録フォームを開く
   - 「モード切替」トグル: パターン表示ON/OFF切り替え

2. **WHEN** パターン登録フォームが開かれる **THEN** システムは以下のUI要素を提供する **SHALL**
   - 曜日選択: ボタングループ（月〜日を選択）
   - コマ選択: ドロップダウンリスト（1, A, B, C）
   - 生徒選択: 検索可能なドロップダウン（オートコンプリート機能付き）
   - 科目選択: 生徒の受講科目から自動フィルタリング
   - 期間設定: カレンダーピッカー

3. **WHEN** パターン一覧が表示される **THEN** システムは以下の機能を提供する **SHALL**
   - ソート機能: 曜日、コマ、講師名、生徒名でソート
   - 検索機能: 生徒名、講師名で検索
   - フィルタ機能: 曜日、コマ、状態（有効/無効）でフィルタ
   - 一括操作: 複数パターンの一括削除、一括無効化

4. **WHEN** カレンダー上のパターン由来セルがクリックされる **THEN** システムはコンテキストメニューを表示し、以下のアクションを提供する **SHALL**
   - 「この日だけ休み」
   - 「生徒を変更」
   - 「パターンを編集」
   - 「パターンを削除」
   - 「詳細を表示」

5. **WHEN** 複数のパターンが重複する（同じ曜日・コマ・講師に複数の生徒）**THEN** システムは警告メッセージ「この時間帯には既に別の生徒が登録されています。1対2指導になります。」を表示する **SHALL**

6. **WHEN** パターンが保存される **THEN** システムは楽観的UI更新を行い、保存処理の完了を待たずに画面を更新する **SHALL**

7. **IF** パターン保存中にエラーが発生する **THEN** システムはUIをロールバックし、エラーメッセージを表示する **SHALL**

---

## 非機能要件

### パフォーマンス

1. **WHEN** 月次カレンダーがロードされる **THEN** システムは1秒以内にパターン展開と表示を完了する **SHALL**

2. **WHEN** パターン一覧が表示される **AND** 100件以上のパターンが存在する **THEN** システムはページネーションまたは仮想スクロールを使用し、初期表示を1秒以内に完了する **SHALL**

### スケーラビリティ

1. **WHEN** システムが稼働する **THEN** 以下のスケールに対応できる **SHALL**
   - 講師数: 100名
   - 生徒数: 500名
   - 定期パターン数: 1000件
   - 月次カレンダー同時アクセス: 50名

### データ保持

1. **WHEN** 定期パターンが削除される **THEN** システムは監査ログに削除記録を保持し、論理削除ではなく物理削除を実行する **SHALL**

2. **WHEN** 個別の例外処理が作成される **THEN** システムは元のパターンIDを参照として保持し、パターン削除後も例外処理の履歴を確認可能とする **SHALL**

---

## 用語集

| 用語 | 定義 |
|------|------|
| 定期授業パターン | 曜日ベースで繰り返される授業の設定（曜日、コマ、講師、生徒、科目、期間） |
| 自動展開 | 定期パターンを月次カレンダーの各該当日付にマッピングして表示する処理 |
| 例外処理 | 特定の日付だけパターンと異なる対応（休み、生徒変更など）を行うこと |
| 個別アサイン | パターンに依存せず、1日限りで直接登録される授業 |
| 確定 | パターンから展開された「予定」を実際のアサインとしてデータベースに保存すること |
| V2システム | 日付ベースのスケジューリングシステム（teacher_availability_v2, assignments） |

---

## 成功指標

1. **入力作業削減率**: 月次カレンダーへの手動入力回数が50%以上削減される
2. **パターン登録数**: 3ヶ月以内に講師の80%が少なくとも1つのパターンを登録
3. **ユーザー満足度**: 講師アンケートで「使いやすい」評価が70%以上
4. **エラー率**: パターン登録・編集時のエラー発生率が5%以下

---

**ステータス**: 要件生成完了
**次のステップ**: `/kiro:spec-design recurring-assignments` を実行して技術設計を生成
